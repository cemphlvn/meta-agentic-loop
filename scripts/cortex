#!/usr/bin/env bash
#
# CORTEX — Cognitive Command Ontology
#
# Hierarchical command tree aligned with cortical columnar organization:
#
#   L1 (Context)     → WHAT domain am I in?
#   L2/3 (Associate) → HOW do things relate?
#   L4 (Input)       → OBSERVE current state
#   L5 (Output)      → ACT on decisions
#   L6 (Feedback)    → LEARN from outcomes
#
# Usage:
#   ./cortex                    # Show command tree
#   ./cortex init <name>        # Initialize new project with plugin
#   ./cortex <layer> <command>  # Execute command in layer
#
# Philosophy:
#   逆水行舟，不进则退 — Like rowing upstream: no advance is to drop back
#

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PLUGIN_REPO="https://github.com/cemphlvn/meta-agentic-loop.git"
LOGICSTICKS_REPO="/Users/cem/Projects/logicsticks.ai"

# Colors
C_L1='\033[1;35m'    # Purple - Context
C_L23='\033[1;36m'   # Cyan - Association
C_L4='\033[1;34m'    # Blue - Input/Observe
C_L5='\033[1;32m'    # Green - Output/Act
C_L6='\033[1;33m'    # Yellow - Feedback/Learn
C_DIM='\033[2m'
C_BOLD='\033[1m'
NC='\033[0m'

# ══════════════════════════════════════════════════════════════════════════════
# CORTICAL COMMAND TREE
# ══════════════════════════════════════════════════════════════════════════════

show_tree() {
    cat << 'EOF'

╔══════════════════════════════════════════════════════════════════════════════╗
║                    CORTEX — Cognitive Command Ontology                        ║
║                                                                               ║
║   Hierarchical organization aligned with neocortical columnar architecture    ║
║   逆水行舟，不进则退 — Like rowing upstream: no advance is to drop back        ║
╚══════════════════════════════════════════════════════════════════════════════╝

EOF

    echo -e "${C_L1}┌─ L1 CONTEXT ─────────────────────────────────────────────────────────────────┐${NC}"
    echo -e "${C_L1}│${NC}  ${C_DIM}What domain? What frame? What essence?${NC}"
    echo -e "${C_L1}│${NC}"
    echo -e "${C_L1}│${NC}  cortex init <name>          Initialize new project with plugin"
    echo -e "${C_L1}│${NC}  cortex frame <mode>         Switch cognitive frame (turkish|chinese|english)"
    echo -e "${C_L1}│${NC}  cortex essence              Show project essence and truth log"
    echo -e "${C_L1}│${NC}  cortex domain               Show current domain ontology"
    echo -e "${C_L1}└──────────────────────────────────────────────────────────────────────────────┘${NC}"
    echo ""

    echo -e "${C_L23}┌─ L2/3 ASSOCIATE ─────────────────────────────────────────────────────────────┐${NC}"
    echo -e "${C_L23}│${NC}  ${C_DIM}How do things relate? What patterns emerge?${NC}"
    echo -e "${C_L23}│${NC}"
    echo -e "${C_L23}│${NC}  cortex agents               Agent hierarchy tree (MECE)"
    echo -e "${C_L23}│${NC}  cortex skills               Skill dependency graph"
    echo -e "${C_L23}│${NC}  cortex scrum                Sprint state and alpha cards"
    echo -e "${C_L23}│${NC}  cortex roadmap              Gantt timeline with DUE dates"
    echo -e "${C_L23}│${NC}  cortex trace <file>         Dependency chain for file"
    echo -e "${C_L23}└──────────────────────────────────────────────────────────────────────────────┘${NC}"
    echo ""

    echo -e "${C_L4}┌─ L4 OBSERVE ──────────────────────────────────────────────────────────────────┐${NC}"
    echo -e "${C_L4}│${NC}  ${C_DIM}What IS the current state? What signals arrive?${NC}"
    echo -e "${C_L4}│${NC}"
    echo -e "${C_L4}│${NC}  cortex status               Git + loop + build status"
    echo -e "${C_L4}│${NC}  cortex health               System health check"
    echo -e "${C_L4}│${NC}  cortex metrics              Agent activity + utilization"
    echo -e "${C_L4}│${NC}  cortex hypothesis           Active hypotheses and tests"
    echo -e "${C_L4}│${NC}  cortex gaps                 MECE coverage gaps"
    echo -e "${C_L4}└──────────────────────────────────────────────────────────────────────────────┘${NC}"
    echo ""

    echo -e "${C_L5}┌─ L5 ACT ──────────────────────────────────────────────────────────────────────┐${NC}"
    echo -e "${C_L5}│${NC}  ${C_DIM}Execute decisions. Produce output. Drive forward.${NC}"
    echo -e "${C_L5}│${NC}"
    echo -e "${C_L5}│${NC}  cortex loop                 Continue the eternal loop"
    echo -e "${C_L5}│${NC}  cortex ralph <task>         Start non-stopping Ralph loop"
    echo -e "${C_L5}│${NC}  cortex orchestrate          Run orchestration cycle"
    echo -e "${C_L5}│${NC}  cortex process <type>       Run process (feature|bugfix|refactor)"
    echo -e "${C_L5}│${NC}  cortex dispatch <agents>    Parallel agent dispatch"
    echo -e "${C_L5}└──────────────────────────────────────────────────────────────────────────────┘${NC}"
    echo ""

    echo -e "${C_L6}┌─ L6 LEARN ────────────────────────────────────────────────────────────────────┐${NC}"
    echo -e "${C_L6}│${NC}  ${C_DIM}What did we learn? How do we improve?${NC}"
    echo -e "${C_L6}│${NC}"
    echo -e "${C_L6}│${NC}  cortex remember             View accumulated truths"
    echo -e "${C_L6}│${NC}  cortex shift                Trigger SHIFT_FELT, integrate new truth"
    echo -e "${C_L6}│${NC}  cortex evolution            System self-improvement timeline"
    echo -e "${C_L6}│${NC}  cortex improve <area>       Meta-improvement flow"
    echo -e "${C_L6}│${NC}  cortex audit                Cross-agent verification"
    echo -e "${C_L6}└──────────────────────────────────────────────────────────────────────────────┘${NC}"
    echo ""

    echo -e "${C_DIM}Quick Start:${NC}"
    echo "  ./cortex init my-project    # Create new project with plugin"
    echo "  cd my-project && claude     # Start Claude Code with full system"
    echo ""
}

# ══════════════════════════════════════════════════════════════════════════════
# INIT — Bootstrap new project with plugin
# ══════════════════════════════════════════════════════════════════════════════

init_project() {
    local name="$1"
    local project_dir="${SCRIPT_DIR}/${name}"

    echo ""
    echo "╔══════════════════════════════════════════════════════════════════╗"
    echo "║  CORTEX INIT — Bootstrapping with meta-agentic-loop              ║"
    echo "╚══════════════════════════════════════════════════════════════════╝"
    echo ""

    # Create project
    mkdir -p "$project_dir"
    cd "$project_dir"

    # Initialize git
    git init
    echo "✓ Git initialized"

    # Add plugin as submodule
    git submodule add "$PLUGIN_REPO" plugin
    echo "✓ Plugin added as submodule"

    # Create .claude directory
    mkdir -p .claude/agents .claude/skills .claude/governance

    # Copy templates from plugin
    if [[ -d "plugin/templates" ]]; then
        cp -r plugin/templates/CLAUDE.md.tmpl CLAUDE.md 2>/dev/null || true
        cp -r plugin/templates/remembrance.tmpl .remembrance 2>/dev/null || true
    fi

    # Create minimal CLAUDE.md if template doesn't exist
    if [[ ! -f "CLAUDE.md" ]]; then
        cat > CLAUDE.md << 'CLAUDE_EOF'
# Project Cockpit

> 逆水行舟，不进则退 — Like rowing upstream: no advance is to drop back

## Commands

See `./cortex` for full command tree.

### Quick Reference
```
./cortex               # Show command hierarchy
./cortex loop          # Continue the eternal loop
./cortex status        # Current state
./cortex agents        # Agent tree
```

## Plugin

This project uses `meta-agentic-loop` plugin.
- Non-stopping runs (Ralph Wiggum)
- Scoped remembrance
- MECE agent hierarchy
- Essence-based scrum
CLAUDE_EOF
    fi

    # Create settings.json with hooks
    cat > .claude/settings.json << 'SETTINGS_EOF'
{
  "$schema": "https://code.claude.com/schemas/settings.json",
  "hooks": {
    "SessionStart": [
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "bash plugin/hooks/scripts/session-start.sh 2>/dev/null || true",
            "timeout": 10
          }
        ]
      }
    ],
    "Stop": [
      {
        "matcher": "*",
        "hooks": [
          {
            "type": "command",
            "command": "bash plugin/hooks/scripts/ralph-stop-hook.sh",
            "timeout": 5,
            "description": "Ralph: Block exit if loop active"
          },
          {
            "type": "command",
            "command": "bash plugin/hooks/scripts/evaluate-session.sh 2>/dev/null || true",
            "timeout": 15
          }
        ]
      }
    ]
  },
  "skills": {
    "sources": [".claude/skills", "plugin/skills"]
  },
  "mcpServers": {
    "context7": {
      "command": "npx",
      "args": ["-y", "@context7/mcp-server"]
    }
  }
}
SETTINGS_EOF

    # Create .remembrance
    cat > .remembrance << 'REM_EOF'
---
timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
scope: SYSTEM
truth: "Project initialized with cortical command ontology"
shape_shift: true
---
REM_EOF

    # Create .gitignore
    cat > .gitignore << 'IGNORE_EOF'
node_modules/
.env
.env.*
*.local.md
.agent-logs/
.DS_Store
IGNORE_EOF

    # Copy cortex command
    cp "${SCRIPT_DIR}/cortex" ./cortex
    chmod +x ./cortex

    # Initial commit
    git add -A
    git commit -m "Initialize with meta-agentic-loop plugin

- Cortical command ontology (./cortex)
- Plugin submodule with Ralph loops
- Scoped remembrance
- Claude Code hooks

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"

    echo ""
    echo "✓ Project initialized: $name"
    echo ""
    echo "Next steps:"
    echo "  cd $name"
    echo "  ./cortex           # See command tree"
    echo "  claude             # Start Claude Code"
    echo ""
}

# ══════════════════════════════════════════════════════════════════════════════
# LAYER COMMANDS
# ══════════════════════════════════════════════════════════════════════════════

# L1 - Context
cmd_frame() {
    local mode="${1:-unified}"
    echo "Switching to frame: $mode"
    case "$mode" in
        turkish)  echo "Ülkün ilerlemek, ileri gitmektir — Your ideal is to progress" ;;
        chinese)  echo "逆水行舟，不进则退 — No advance is to drop back" ;;
        english)  echo "Forward, always forward" ;;
        unified)  echo "All three frames synthesized" ;;
    esac
}

cmd_essence() {
    echo "Project Essence:"
    if [[ -f ".remembrance" ]]; then
        grep -A2 "shape_shift: true" .remembrance 2>/dev/null | tail -10
    else
        echo "  No .remembrance found"
    fi
}

# L2/3 - Associate
cmd_agents() {
    echo "Agent Hierarchy (MECE):"
    if [[ -f ".claude/agents/INDEX.md" ]]; then
        grep -E "^│|^├|^└|^\*" .claude/agents/INDEX.md 2>/dev/null | head -30
    elif [[ -f "plugin/.claude/agents/INDEX.md" ]]; then
        grep -E "^│|^├|^└|^\*" plugin/.claude/agents/INDEX.md 2>/dev/null | head -30
    else
        echo "  No agent index found"
    fi
}

# L4 - Observe
cmd_status() {
    echo ""
    echo "=== STATUS ==="
    echo ""
    echo "Git:"
    git status -sb 2>/dev/null || echo "  Not a git repo"
    echo ""
    echo "Loop State:"
    if [[ -f ".loop-state.yaml" ]]; then
        grep -E "^phase:|^iteration:|^last_action:" .loop-state.yaml 2>/dev/null
    else
        echo "  No loop state"
    fi
    echo ""
    echo "Build:"
    if [[ -f "package.json" ]]; then
        pnpm run build --dry-run 2>/dev/null && echo "  ✓ Build ready" || echo "  ✗ Build issues"
    fi
}

cmd_health() {
    echo "System Health:"
    if [[ -x "plugin/diagnostics/repo-audit.sh" ]]; then
        bash plugin/diagnostics/repo-audit.sh 2>/dev/null || echo "  Audit script failed"
    else
        echo "  No health check available"
    fi
}

# L5 - Act
cmd_loop() {
    echo "Continuing the loop..."
    if [[ -x "plugin/scripts/loop/loop-runner.sh" ]]; then
        bash plugin/scripts/loop/loop-runner.sh
    else
        echo "  Loop runner not found. Start Claude Code instead."
    fi
}

cmd_ralph() {
    local task="$1"
    if [[ -z "$task" ]]; then
        echo "Usage: cortex ralph \"Task description\""
        return 1
    fi
    if [[ -x "plugin/scripts/loop/ralph-loop.sh" ]]; then
        bash plugin/scripts/loop/ralph-loop.sh "$task"
    else
        echo "  Ralph loop not found"
    fi
}

# L6 - Learn
cmd_remember() {
    echo "Accumulated Truths:"
    if [[ -f ".remembrance" ]]; then
        cat .remembrance
    else
        echo "  No .remembrance found"
    fi
}

cmd_shift() {
    echo "SHIFT_FELT triggered — integrating new truths..."
    if [[ -f ".remembrance" ]]; then
        echo "Re-reading remembrance..."
        grep "shape_shift: true" .remembrance | wc -l | xargs echo "  Shape shifts:"
    fi
}

cmd_evolution() {
    echo "Evolution Timeline:"
    if [[ -f "scrum/EVOLUTION.md" ]]; then
        head -50 scrum/EVOLUTION.md
    else
        echo "  No evolution log"
    fi
}

# ══════════════════════════════════════════════════════════════════════════════
# CLI ROUTER
# ══════════════════════════════════════════════════════════════════════════════

case "${1:-}" in
    "")           show_tree ;;
    init)         init_project "${2:-new-project}" ;;
    # L1
    frame)        cmd_frame "${2:-}" ;;
    essence)      cmd_essence ;;
    domain)       echo "Domain ontology: see CLAUDE.md" ;;
    # L2/3
    agents)       cmd_agents ;;
    skills)       echo "Skills: see .claude/skills/" ;;
    scrum)        cat scrum/SCRUM.md 2>/dev/null || echo "No SCRUM.md" ;;
    roadmap)      cat scrum/ROADMAP.md 2>/dev/null || echo "No ROADMAP.md" ;;
    trace)        echo "Trace: $2" ;;
    # L4
    status)       cmd_status ;;
    health)       cmd_health ;;
    metrics)      echo "Metrics: see .observability/" ;;
    hypothesis)   echo "Hypotheses: see .observability/hypotheses/" ;;
    gaps)         grep "\[GAP\]" .claude/agents/INDEX.md 2>/dev/null || echo "No gaps" ;;
    # L5
    loop)         cmd_loop ;;
    ralph)        cmd_ralph "$2" ;;
    orchestrate)  echo "Run: claude /orchestrate" ;;
    process)      echo "Run: claude /process $2" ;;
    dispatch)     echo "Run: claude with parallel Task tools" ;;
    # L6
    remember)     cmd_remember ;;
    shift)        cmd_shift ;;
    evolution)    cmd_evolution ;;
    improve)      echo "Run: claude /improve $2" ;;
    audit)        echo "Run: claude /audit" ;;
    # Help
    help|--help|-h) show_tree ;;
    *)
        echo "Unknown command: $1"
        echo "Run ./cortex for command tree"
        exit 1
        ;;
esac
